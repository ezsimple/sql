CREATE PROCEDURE  `SP_STATS_GAME_SCORE_POPUP`(
IN $GM_CODE CHAR(13),
IN $MM_CODE VARCHAR(10)
)
BEGIN

    DECLARE $MAX_RNDG INT;

    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    SELECT MAX(TOMT_RNDG) INTO $MAX_RNDG
    FROM VW_STATS_SCORE_COMMON
    WHERE GM_CODE = $GM_CODE;

    SET @SQL_SELECT_FROM = "SELECT * FROM ";

    SET @SQL_CDP = CONCAT('(SELECT CD_1P, CD_2P, CD_3P, CD_4P, CD_5P, CD_6P, CD_7P, CD_8P, CD_9P, CD_TOUT, CD_10P, CD_11P, CD_12P, CD_13P, CD_14P, CD_15P, CD_16P, CD_17P, CD_18P
                    FROM VW_STATS_SCORE_COMMON WHERE GM_CODE = "',$GM_CODE,'") PAR, ');

    IF ($MAX_RNDG >= 1) THEN
      SET @SQL_R1 = CONCAT('(SELECT H01 AS R1H01, H02 AS R1H02, H03 AS R1H03, H04 AS R1H04, H05 AS R1H05, H06 AS R1H06, H07 AS R1H07, H08 AS R1H08, H09 AS R1H09, HOUT AS R1HOUT,
                        H10 AS R1H10, H11 AS R1H11, H12 AS R1H12, H13 AS R1H13, H14 AS R1H14, H15 AS R1H15, H16 AS R1H16, H17 AS R1H17, H18 AS R1H18, HIN AS R1HIN,
                        (H01+H02+H03+H04+H05+H06+H07+H08+H09+H10+H11+H12+H13+H14+H15+H16+H17+H18) AS R1TOTAL
                        FROM CG_SCOR_MGT_MST WHERE GAME_CODE = "',$GM_CODE,'" AND MAN_CD = "',$MM_CODE,'" AND TOMT_RNDG = "1") R1 ');
    END IF;

    IF ($MAX_RNDG >= 2) THEN
      SET @SQL_R2 = CONCAT(',(SELECT H01 AS R2H01, H02 AS R2H02, H03 AS R2H03, H04 AS R2H04, H05 AS R2H05, H06 AS R2H06, H07 AS R2H07, H08 AS R2H08, H09 AS R2H09, HOUT AS R2HOUT,
                       H10 AS R2H10, H11 AS R2H11, H12 AS R2H12, H13 AS R2H13, H14 AS R2H14, H15 AS R2H15, H16 AS R2H16, H17 AS R2H17, H18 AS R2H18, HIN AS R2HIN,
                       (H01+H02+H03+H04+H05+H06+H07+H08+H09+H10+H11+H12+H13+H14+H15+H16+H17+H18) AS R2TOTAL
                       FROM CG_SCOR_MGT_MST WHERE GAME_CODE = "',$GM_CODE,'" AND MAN_CD = "',$MM_CODE,'" AND TOMT_RNDG = "2") R2 ');
    ELSE
      SET @SQL_R2 = "";
    END IF;

    IF ($MAX_RNDG >= 3) THEN
      SET @SQL_R3 = CONCAT(',(SELECT H01 AS R3H01, H02 AS R3H02, H03 AS R3H03, H04 AS R3H04, H05 AS R3H05, H06 AS R3H06, H07 AS R3H07, H08 AS R3H08, H09 AS R3H09, HOUT AS R3HOUT,
                       H10 AS R3H10, H11 AS R3H11, H12 AS R3H12, H13 AS R3H13, H14 AS R3H14, H15 AS R3H15, H16 AS R3H16, H17 AS R3H17, H18 AS R3H18, HIN AS R3HIN,
                       (H01+H02+H03+H04+H05+H06+H07+H08+H09+H10+H11+H12+H13+H14+H15+H16+H17+H18) AS R3TOTAL
                       FROM CG_SCOR_MGT_MST WHERE GAME_CODE = "',$GM_CODE,'" AND MAN_CD = "',$MM_CODE,'" AND TOMT_RNDG = "3") R3 ');
    ELSE
      SET @SQL_R3 = "";
    END IF;

    IF ($MAX_RNDG >= 4) THEN
      SET @SQL_R4 = CONCAT(',(SELECT H01 AS R4H01, H02 AS R4H02, H03 AS R4H03, H04 AS R4H04, H05 AS R4H05, H06 AS R4H06, H07 AS R4H07, H08 AS R4H08, H09 AS R4H09, HOUT AS R4HOUT,
                       H10 AS R4H10, H11 AS R4H11, H12 AS R4H12, H13 AS R4H13, H14 AS R4H14, H15 AS R4H15, H16 AS R4H16, H17 AS R4H17, H18 AS R4H18, HIN AS R4HIN,
                       (H01+H02+H03+H04+H05+H06+H07+H08+H09+H10+H11+H12+H13+H14+H15+H16+H17+H18) AS R4TOTAL
                       FROM CG_SCOR_MGT_MST WHERE GAME_CODE = "',$GM_CODE,'" AND MAN_CD = "',$MM_CODE,'" AND TOMT_RNDG = "4") R4 ');
    ELSE
      SET @SQL_R4 = "";
    END IF;

    SET @SQL_QUERY = CONCAT(@SQL_SELECT_FROM, @SQL_CDP, @SQL_R1, @SQL_R2, @SQL_R3, @SQL_R4);
    PREPARE $QUERY FROM @SQL_QUERY;
    EXECUTE $QUERY;
    DEALLOCATE PREPARE $QUERY;

    -- (SELECT P01 AS R1P01, P02 AS R1P02, P03 AS R1P03, P04 AS R1P04, P05 AS R1P05, P06 AS R1P06, P07 AS R1P07, P08 AS R1P08, P09 AS R1P09, POUT AS R1POUT,
    --   P10 AS R1P10, P11 AS R1P11, P12 AS R1P12, P13 AS R1P13, P14 AS R1P14, P15 AS R1P15, P16 AS R1P16, P17 AS R1P17, P18 AS R1P18, PIN AS R1PIN,
    -- (P01+P02+P03+P04+P05+P06+P07+P08+P09+P10+P11+P12+P13+P14+P15+P16+P17+P18) AS P1TOTAL
    -- FROM CG_SCOR_MGT_MST WHERE GAME_CODE = $GM_CODE AND MAN_CD = $MM_CODE AND TOMT_RNDG = '1') P1;

END;
